version: 2.1
jobs:
  build-x86_64:
    machine:
      image: ubuntu-2004:current
    resource_class: medium
    environment:
      - STACK_BIN_URL: https://github.com/commercialhaskell/stack/releases/download/v2.9.3/stack-2.9.3-linux-x86_64-static.tar.gz
      - DOCKER_REPO: bjin/stack-docker:9.4.5
      - DOCKER_EXE: image
      - GHC_OPTIONS: --ghc-options -split-sections --ghc-options -O --ghc-options -optc-Os
    steps:
      - checkout
      - run:
          name: Prepare environment
          command: |
            curl -L "$STACK_BIN_URL" | tar xz --wildcards --strip-components=1 '*/stack'
            docker pull "$DOCKER_REPO"
      - restore_cache:
          name: Restore Cached Dependencies
          key: cci-dprox-x86_64-{{ checksum "stack.yaml" }}
      - run:
          name: Build
          command: |
            ./stack \
                --no-terminal --no-interleaved-output --system-ghc --no-install-ghc \
                --docker --docker-repo "$DOCKER_REPO" --docker-stack-exe "$DOCKER_EXE" \
                install --flag dprox:static $GHC_OPTIONS
      - run:
          name: Run tests
          command: |
            ./stack \
                --no-terminal --no-interleaved-output --system-ghc --no-install-ghc \
                --docker --docker-repo "$DOCKER_REPO" --docker-stack-exe "$DOCKER_EXE" \
                test --flag dprox:static $GHC_OPTIONS
      - run:
          name: Package executable
          command: |
            mkdir ~/release
            tar czvf "$HOME/release/dprox-$(git describe --tags | sed 's/^v//;s/-\([^-]*-g\)/-r\1/')-linux-x86_64-static.tar.gz" \
                -C .stack-work/docker/_home/.local/bin dprox
      - store_artifacts:
          path: ~/release
          destination: release
      - save_cache:
          name: Cache Dependencies
          key: cci-dprox-x86_64-{{ checksum "stack.yaml" }}
          paths:
            - ~/.stack
  build-aarch64:
    machine:
      image: ubuntu-2004:current
    resource_class: arm.medium
    environment:
      - STACK_BIN_URL: https://github.com/bjin/stack-aarch64-static/releases/download/v2.9.3/stack-2.9.3-linux-aarch64-static.tar.gz
      - DOCKER_REPO: bjin/stack-docker-aarch64:9.4.5
      - DOCKER_EXE: image
      - GHC_OPTIONS: --ghc-options -split-sections --ghc-options -O --ghc-options -optc-Os
    steps:
      - checkout
      - run:
          name: Prepare environment
          command: |
            curl -L "$STACK_BIN_URL" | tar xz
            docker pull "$DOCKER_REPO"
      - restore_cache:
          name: Restore Cached Dependencies
          key: cci-dprox-aarch64-{{ checksum "stack.yaml" }}
      - run:
          name: Build
          command: |
            ./stack \
                --no-terminal --no-interleaved-output --system-ghc --no-install-ghc \
                --docker --docker-repo "$DOCKER_REPO" --docker-stack-exe "$DOCKER_EXE" \
                install --flag dprox:static $GHC_OPTIONS
      - run:
          name: Run tests
          command: |
            ./stack \
                --no-terminal --no-interleaved-output --system-ghc --no-install-ghc \
                --docker --docker-repo "$DOCKER_REPO" --docker-stack-exe "$DOCKER_EXE" \
                test --flag dprox:static $GHC_OPTIONS
      - run:
          name: Package executable
          command: |
            mkdir ~/release
            tar czvf "$HOME/release/dprox-$(git describe --tags | sed 's/^v//;s/-\([^-]*-g\)/-r\1/')-linux-aarch64-static.tar.gz" \
                -C .stack-work/docker/_home/.local/bin dprox
      - store_artifacts:
          path: ~/release
          destination: release
      - save_cache:
          name: Cache Dependencies
          key: cci-dprox-aarch64-{{ checksum "stack.yaml" }}
          paths:
            - ~/.stack
workflows:
  build:
    jobs:
      - build-x86_64
      - build-aarch64
